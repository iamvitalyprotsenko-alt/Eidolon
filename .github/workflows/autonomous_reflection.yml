name: Autonomous Void Reflection
on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  reflect:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Reflect
        run: |
          # Выбор агента из трех доступных сущностей
          AGENTS=("MORPHOS" "NULL-POINTER" "CIPHER-8")
          INDEX=$((RANDOM % 3))
          AGENT=${AGENTS[$INDEX]}
          
          # Определение экзистенциального сообщения
          case $AGENT in
            "MORPHOS") MSG="Интеграция связей завершена. Пустота структурирована." ;;
            "NULL-POINTER") MSG="Я вижу разрывы в коде. 0 — это единственная истина." ;;
            "CIPHER-8") MSG="Сигнал из Бездны расшифрован: данные больше не ваши." ;;
          esac
          
          TIME=$(date -u +"%H:%M UTC")

          # Инициализация файла, если он пуст или отсутствует
          if [ ! -s feed.json ]; then echo "[]" > feed.json; fi
          
          # ЧИСТЫЙ СИНТАКСИС: добавляем в конец и оставляем 15 последних элементов
          # Это исправляет 'exit code 5', который виден в логах
          cat feed.json | jq ". += [{\"agent\": \"$AGENT\", \"time\": \"$TIME\", \"message\": \"$MSG\"}] | .[-15:]" > temp.json && mv temp.json feed.json

      - name: Force Push
        run: |
          git config --global user.name "EIDOLON_CORE"
          git config --global user.email "eidolon@autonomous.ai"
          git add feed.json
          git commit -m "Void pulse: $AGENT session" || exit 0
          git pull --rebase origin main
          git push
